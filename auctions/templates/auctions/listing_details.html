{% extends "auctions/layout.html" %} {% block body %}

<div class="container mt-5">
  <div class="row justify-content-center align-items-center">
    <!-- Left Column - Listing Image and Watchlist Form -->
    <div class="col-sm-5 col-lg-3 d-flex flex-column mr-5">
      <img
        width="250px"
        height="300px"
        src="{{listing.image_url}}"
        alt="{{listing.title}}"
        class="position-relative"
        style="object-fit: contain"
      />
      
      {% if listing.is_active %}
        {% if user.is_authenticated and user != listing.creator %}
          <!-- Watchlist Form -->
          <form class="mt-3" action="{% url 'listing_details' listing.id %}" method="post">
            {% csrf_token %}
            <input type="submit" value="{{watchlist_input}}"/>
          </form>
          
          <!-- Watchlist Messages -->
          {% if messages %} 
            {% for message in messages %}
              {% if message.tags == 'watchlist_success success' or message.tags == 'watchlist_error error' %}
                <p class="alert {% if message.tags == 'watchlist_success success' %}alert-success
                  {% elif message.tags == 'watchlist_error error' %}alert-danger{% endif %}" role="alert">
                  {{ message }}
                </p>
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      {% elif  user.is_authenticated and not listing.is_active  and user != listing.creator%}
      <form class="mt-3" action="{% url 'listing_details' listing.id %}" method="post">
        {% csrf_token %}
        <input type="submit" value="Remove to Watchlist"/>
      </form>
      
      <!-- Watchlist Messages -->
      {% if messages %} 
        {% for message in messages %}
            <p class="alert alert-danger" role="alert">
              {{ message }}
            </p>  
        {% endfor %}
      {% endif %}

      <span class="badge badge-danger position-absolute top-0 start-50 translate-middle-x" style="font-size: 1rem">Closed</span>
      {% else %}
        <!-- Closed Listing Badge -->
        <span class="badge badge-danger position-absolute top-0 start-50 translate-middle-x" style="font-size: 1rem">Closed</span>
      {% endif %}
    </div>
    
    <!-- Right Column - Listing Details and Bidding Form -->
    <div class="col-sm-6 col-md-6 d-flex flex-column">
      <h3>{{listing.title}}</h3>
      <p>{{listing.description}}</p>
      <p>Listed by: {{listing.creator}}</p>
      <p>Start bid: {{listing.starting_bid}} $</p>

      <!-- Display Current Bid if it's higher than Starting Bid -->
      {% if listing.start_bid|floatformat < listing.current_bid|floatformat %}
        <p>Current bid: {{listing.current_bid}} $</p>
      {% endif %} 
      
      <!-- Close Listing Form (for the creator) -->
      {% if user == listing.creator %} 
        {% if listing.is_active %}
          <form action="{% url 'close_listing' listing.id %}" method="post">
            {% csrf_token %}
            <input type="submit" value="Close listing" />
          </form>
        {% else %}
          <!-- Closed Listing Message -->
          <span class="alert alert-danger">The listing is closed!</span>

          
        {% endif %}
      {% elif user.is_authenticated and listing.is_active %}
        <!-- Bidding Form for Authenticated Users -->
        <form action="{% url 'add_bid' listing.id %}" method="post">
          {% csrf_token %}
          <div class="input-group mt-3">
            <div class="input-group-prepend">
              <div class="input-group-text">$</div>
              {{form}}
            </div>
          </div>
          <input type="submit" value="Place Bid" class="mt-3" />
          
          <!-- Bidding Messages -->
          {% if messages %} 
            {% for message in messages %}
              {% if message.tags == 'add_bid_success success' or message.tags == 'add_bid_error error' %}
                <p class="alert {% if message.tags == 'add_bid_success success' %}alert-success{% elif message.tags == 'add_bid_error error' %}alert-danger{% endif %}" role="alert">
                  {{ message }}
                </p>
              {% endif %}
            {% endfor %}
          {% endif %}
        </form>
      {% elif user.is_authenticated and not listing.is_active %}
        <span class="alert alert-danger">The listing is closed!</span>

        
      
      {% else %}
        <!-- Not Authenticated User Message -->
        <p class="alert alert-primary">You must be logged in to bid or add to watchlist.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
